{
  "name": "SBL Onboarding - Form Abandonment",
  "nodes": [
    {
      "parameters": {
        "path": "formulario-sbl-abandonment",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-abandonment",
      "name": "Webhook - Form Abandoned",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "formulario-sbl-abandonment"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": true, \"message\": \"Abandonment notification received\", \"timestamp\": $now } }}"
      },
      "id": "webhook-response",
      "name": "Webhook Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.event }}",
              "value2": "form_abandoned"
            }
          ]
        }
      },
      "id": "check-event-type",
      "name": "Check Event Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "functionCode": "// Extrair dados do abandono\nconst data = $input.item.json.data || {};\nconst metadata = $input.item.json.metadata || {};\n\n// Formatar dados para email\nconst emailData = {\n  email: data.email || '',\n  fullName: data.full_name || 'Candidato',\n  phone: data.phone || '',\n  abandonedStep: data.abandoned_at_step || 1,\n  language: data.language || 'en',\n  selectedDepot: data.selected_depot || 'N/A',\n  returnUrl: data.return_url || '',\n  completedSteps: data.completed_steps || [],\n  totalSteps: 11,\n  progressPercentage: Math.round((data.completed_steps?.length || 0) / 11 * 100),\n  timestamp: $input.item.json.timestamp || new Date().toISOString(),\n  userAgent: metadata.user_agent || '',\n  source: metadata.source || 'sbl_onboarding_form'\n};\n\n// Determinar mensagem baseada no idioma\nconst messages = {\n  'en': {\n    subject: 'Complete Your SBL Application',\n    greeting: 'Hello',\n    body: `We noticed you started your application with Silva Brothers Logistics but didn't finish.\\n\\nYou were on step ${emailData.abandonedStep} of ${emailData.totalSteps} (${emailData.progressPercentage}% complete).\\n\\nWe'd love to have you join our team! Complete your application now:`,\n    cta: 'Continue Application',\n    footer: 'If you have any questions, feel free to contact us.\\n\\nBest regards,\\nSilva Brothers Logistics Team'\n  },\n  'pt-BR': {\n    subject: 'Complete Sua Candidatura na SBL',\n    greeting: 'Ol√°',\n    body: `Notamos que voc√™ come√ßou sua candidatura na Silva Brothers Logistics mas n√£o finalizou.\\n\\nVoc√™ estava na etapa ${emailData.abandonedStep} de ${emailData.totalSteps} (${emailData.progressPercentage}% completo).\\n\\nGostar√≠amos muito de ter voc√™ em nosso time! Complete sua candidatura agora:`,\n    cta: 'Continuar Candidatura',\n    footer: 'Se tiver alguma d√∫vida, n√£o hesite em nos contatar.\\n\\nAtenciosamente,\\nEquipe Silva Brothers Logistics'\n  },\n  'bg': {\n    subject: '–ó–∞–≤—ä—Ä—à–µ—Ç–µ –í–∞—à–∞—Ç–∞ –ö–∞–Ω–¥–∏–¥–∞—Ç—É—Ä–∞ –∑–∞ SBL',\n    greeting: '–ó–¥—Ä–∞–≤–µ–π—Ç–µ',\n    body: `–ó–∞–±–µ–ª—è–∑–∞—Ö–º–µ, —á–µ –∑–∞–ø–æ—á–Ω–∞—Ö—Ç–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—É—Ä–∞—Ç–∞ —Å–∏ –≤ Silva Brothers Logistics, –Ω–æ –Ω–µ —è –∑–∞–≤—ä—Ä—à–∏—Ö—Ç–µ.\\n\\n–ë—è—Ö—Ç–µ –Ω–∞ —Å—Ç—ä–ø–∫–∞ ${emailData.abandonedStep} –æ—Ç ${emailData.totalSteps} (${emailData.progressPercentage}% –∑–∞–≤—ä—Ä—à–µ–Ω–æ).\\n\\n–ë–∏—Ö–º–µ –∏—Å–∫–∞–ª–∏ –¥–∞ —Å–µ –ø—Ä–∏—Å—ä–µ–¥–∏–Ω–∏—Ç–µ –∫—ä–º –Ω–∞—à–∏—è –µ–∫–∏–ø! –ó–∞–≤—ä—Ä—à–µ—Ç–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—É—Ä–∞—Ç–∞ —Å–∏ —Å–µ–≥–∞:`,\n    cta: '–ü—Ä–æ–¥—ä–ª–∂–µ—Ç–µ –ö–∞–Ω–¥–∏–¥–∞—Ç—É—Ä–∞—Ç–∞',\n    footer: '–ê–∫–æ –∏–º–∞—Ç–µ –≤—ä–ø—Ä–æ—Å–∏, –º–æ–ª—è —Å–≤—ä—Ä–∂–µ—Ç–µ —Å–µ —Å –Ω–∞—Å.\\n\\n–° —É–≤–∞–∂–µ–Ω–∏–µ,\\n–ï–∫–∏–ø—ä—Ç –Ω–∞ Silva Brothers Logistics'\n  },\n  'ro': {\n    subject: 'CompleteazƒÉ Aplica»õia Ta pentru SBL',\n    greeting: 'BunƒÉ',\n    body: `Am observat cƒÉ ai √Ænceput aplica»õia ta la Silva Brothers Logistics dar nu ai finalizat-o.\\n\\nErai la pasul ${emailData.abandonedStep} din ${emailData.totalSteps} (${emailData.progressPercentage}% completat).\\n\\nNe-ar plƒÉcea sƒÉ te alƒÉturi echipei noastre! CompleteazƒÉ aplica»õia acum:`,\n    cta: 'ContinuƒÉ Aplica»õia',\n    footer: 'DacƒÉ ai √ÆntrebƒÉri, nu ezita sƒÉ ne contactezi.\\n\\nCu stimƒÉ,\\nEchipa Silva Brothers Logistics'\n  }\n};\n\nconst lang = emailData.language || 'en';\nconst msg = messages[lang] || messages['en'];\n\nemailData.subject = msg.subject;\nemailData.greeting = msg.greeting;\nemailData.bodyText = msg.body;\nemailData.ctaText = msg.cta;\nemailData.footer = msg.footer;\n\nreturn { json: emailData };"
      },
      "id": "process-abandonment-data",
      "name": "Process Abandonment Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [850, 200]
    },
    {
      "parameters": {
        "fromEmail": "noreply@silvabrotherslogistics.com",
        "toEmail": "={{ $json.email }}",
        "subject": "={{ $json.subject }}",
        "emailType": "html",
        "message": "={{ `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { background: #17A798; color: white; padding: 30px; text-align: center; border-radius: 8px 8px 0 0; }\n    .content { background: #f5f5f5; padding: 30px; }\n    .cta-button { display: inline-block; background: #17A798; color: white; padding: 15px 30px; text-decoration: none; border-radius: 5px; margin: 20px 0; font-weight: bold; }\n    .footer { background: #333; color: white; padding: 20px; text-align: center; font-size: 12px; border-radius: 0 0 8px 8px; }\n    .progress-bar { background: #ddd; height: 20px; border-radius: 10px; overflow: hidden; margin: 20px 0; }\n    .progress-fill { background: #17A798; height: 100%; transition: width 0.3s; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>Silva Brothers Logistics LTD</h1>\n    </div>\n    <div class=\"content\">\n      <h2>${$json.greeting} ${$json.fullName},</h2>\n      <p>${$json.bodyText}</p>\n      \n      <div class=\"progress-bar\">\n        <div class=\"progress-fill\" style=\"width: ${$json.progressPercentage}%;\"></div>\n      </div>\n      <p style=\"text-align: center; color: #666;\">Progress: ${$json.progressPercentage}% complete</p>\n      \n      <div style=\"text-align: center;\">\n        <a href=\"${$json.returnUrl}\" class=\"cta-button\">${$json.ctaText}</a>\n      </div>\n      \n      <p style=\"white-space: pre-line;\">${$json.footer}</p>\n    </div>\n    <div class=\"footer\">\n      <p>&copy; 2025 Silva Brothers Logistics LTD. All rights reserved.</p>\n    </div>\n  </div>\n</body>\n</html>\n` }}"
      },
      "id": "send-email",
      "name": "Send Abandonment Email",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [1050, 200],
      "credentials": {
        "smtp": {
          "id": "1",
          "name": "SMTP Account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.phone }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "check-phone",
      "name": "Check if Phone Available",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [850, 400]
    },
    {
      "parameters": {
        "functionCode": "// Preparar mensagem WhatsApp baseada no idioma\nconst data = $input.item.json;\nconst messages = {\n  'en': `Hi ${data.fullName}! üëã\\n\\nWe noticed you started your application with Silva Brothers Logistics but didn't complete it.\\n\\nYou're ${data.progressPercentage}% done - just ${11 - data.completedSteps.length} more steps!\\n\\nContinue here: ${data.returnUrl}\\n\\nNeed help? Reply to this message!`,\n  'pt-BR': `Oi ${data.fullName}! üëã\\n\\nNotamos que voc√™ come√ßou sua candidatura na Silva Brothers Logistics mas n√£o completou.\\n\\nVoc√™ est√° ${data.progressPercentage}% pronto - faltam apenas ${11 - data.completedSteps.length} etapas!\\n\\nContinue aqui: ${data.returnUrl}\\n\\nPrecisa de ajuda? Responda esta mensagem!`,\n  'bg': `–ó–¥—Ä–∞–≤–µ–π ${data.fullName}! üëã\\n\\n–ó–∞–±–µ–ª—è–∑–∞—Ö–º–µ, —á–µ –∑–∞–ø–æ—á–Ω–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç—É—Ä–∞—Ç–∞ —Å–∏ –≤ Silva Brothers Logistics, –Ω–æ –Ω–µ —è –∑–∞–≤—ä—Ä—à–∏.\\n\\n–ì–æ—Ç–æ–≤ —Å–∏ –Ω–∞ ${data.progressPercentage}% - –æ—Å—Ç–∞–≤–∞—Ç —Å–∞–º–æ ${11 - data.completedSteps.length} —Å—Ç—ä–ø–∫–∏!\\n\\n–ü—Ä–æ–¥—ä–ª–∂–∏ —Ç—É–∫: ${data.returnUrl}\\n\\n–¢—Ä—è–±–≤–∞ –ª–∏ –ø–æ–º–æ—â? –û—Ç–≥–æ–≤–æ—Ä–∏ –Ω–∞ —Ç–æ–≤–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ!`,\n  'ro': `BunƒÉ ${data.fullName}! üëã\\n\\nAm observat cƒÉ ai √Ænceput aplica»õia la Silva Brothers Logistics dar nu ai finalizat-o.\\n\\nE»ôti ${data.progressPercentage}% gata - mai sunt doar ${11 - data.completedSteps.length} pa»ôi!\\n\\nContinuƒÉ aici: ${data.returnUrl}\\n\\nAi nevoie de ajutor? RƒÉspunde la acest mesaj!`\n};\n\nconst lang = data.language || 'en';\nconst message = messages[lang] || messages['en'];\n\nreturn {\n  json: {\n    phone: data.phone,\n    message: message,\n    fullName: data.fullName\n  }\n};"
      },
      "id": "prepare-whatsapp",
      "name": "Prepare WhatsApp Message",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "phoneNumber": "={{ $json.phone }}",
        "message": "={{ $json.message }}"
      },
      "id": "send-whatsapp",
      "name": "Send WhatsApp",
      "type": "n8n-nodes-base.whatsapp",
      "typeVersion": 1,
      "position": [1250, 400],
      "credentials": {
        "whatsappApi": {
          "id": "2",
          "name": "WhatsApp Business API"
        }
      }
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "form_abandonments",
        "columns": "email, phone, full_name, abandoned_at_step, language, selected_depot, followup_sent, followup_type, created_at",
        "values": "={{ $json.email }}, ={{ $json.phone }}, ={{ $json.fullName }}, ={{ $json.abandonedStep }}, ={{ $json.language }}, ={{ $json.selectedDepot }}, true, email, ={{ $now }}"
      },
      "id": "log-to-supabase",
      "name": "Log Abandonment to Supabase",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [1250, 200],
      "credentials": {
        "postgres": {
          "id": "3",
          "name": "Supabase Database"
        }
      }
    }
  ],
  "connections": {
    "Webhook - Form Abandoned": {
      "main": [
        [
          {
            "node": "Webhook Response",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check Event Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Event Type": {
      "main": [
        [
          {
            "node": "Process Abandonment Data",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check if Phone Available",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Abandonment Data": {
      "main": [
        [
          {
            "node": "Send Abandonment Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Abandonment Email": {
      "main": [
        [
          {
            "node": "Log Abandonment to Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Phone Available": {
      "main": [
        [
          {
            "node": "Prepare WhatsApp Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare WhatsApp Message": {
      "main": [
        [
          {
            "node": "Send WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {},
  "versionId": "1.0.0",
  "id": "sbl-onboarding-abandonment",
  "meta": {
    "instanceId": "heavydragonfly-n8n"
  },
  "tags": []
}
