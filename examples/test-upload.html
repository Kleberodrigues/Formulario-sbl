<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Teste Upload Supabase</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    button {
      background: #17A798;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover { background: #148882; }
    input[type="file"] {
      display: block;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>üß™ Teste de Upload - Supabase Storage</h1>

  <div id="status"></div>

  <div>
    <h3>1. Verificar Conex√£o Supabase</h3>
    <button onclick="testConnection()">Testar Conex√£o</button>
  </div>

  <div>
    <h3>2. Verificar Bucket 'form-documents'</h3>
    <button onclick="testBucket()">Verificar Bucket</button>
  </div>

  <div>
    <h3>3. Testar Upload de Arquivo</h3>
    <input type="file" id="fileInput" accept="image/*" />
    <button onclick="testUpload()">Fazer Upload</button>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

    const SUPABASE_URL = 'https://lebmfeekwgcfbirzkuel.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxlYm1mZWVrd2djZmJpcnprdWVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzEwOTc5NTUsImV4cCI6MjA0NjY3Mzk1NX0.d_5a9nzh0F7PbhHAVHK1WZFh11LSCr7TtcZZGN5Sc-E'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status')
      statusDiv.innerHTML += `<div class="status ${type}">${message}</div>`
      console.log(message)
    }

    window.testConnection = async function() {
      showStatus('üîÑ Testando conex√£o com Supabase...', 'info')

      try {
        const { data, error } = await supabase
          .from('form_submissions')
          .select('count')
          .limit(1)

        if (error) throw error

        showStatus('‚úÖ Conex√£o com Supabase OK!', 'success')
        showStatus(`üìä Tabela form_submissions existe e est√° acess√≠vel`, 'success')
      } catch (error) {
        showStatus(`‚ùå Erro na conex√£o: ${error.message}`, 'error')
        console.error(error)
      }
    }

    window.testBucket = async function() {
      showStatus('üîÑ Verificando bucket "form-documents"...', 'info')

      try {
        const { data, error } = await supabase
          .storage
          .listBuckets()

        if (error) throw error

        const bucket = data.find(b => b.name === 'form-documents')

        if (bucket) {
          showStatus('‚úÖ Bucket "form-documents" encontrado!', 'success')
          showStatus(`üì¶ Bucket √© p√∫blico: ${bucket.public ? 'SIM' : 'N√ÉO'}`, 'info')

          // Testar listagem de arquivos
          const { data: files, error: listError } = await supabase
            .storage
            .from('form-documents')
            .list('', { limit: 5 })

          if (listError) throw listError

          showStatus(`üìÅ Arquivos no bucket: ${files.length}`, 'info')
        } else {
          showStatus('‚ùå Bucket "form-documents" N√ÉO encontrado!', 'error')
          showStatus('üí° Crie o bucket no Supabase Dashboard > Storage', 'info')
        }
      } catch (error) {
        showStatus(`‚ùå Erro ao verificar bucket: ${error.message}`, 'error')
        console.error(error)
      }
    }

    window.testUpload = async function() {
      const fileInput = document.getElementById('fileInput')
      const file = fileInput.files[0]

      if (!file) {
        showStatus('‚ö†Ô∏è Selecione um arquivo primeiro!', 'error')
        return
      }

      showStatus(`üîÑ Fazendo upload de "${file.name}"...`, 'info')

      try {
        const filePath = `test/${Date.now()}_${file.name}`

        const { data, error } = await supabase.storage
          .from('form-documents')
          .upload(filePath, file, {
            cacheControl: '3600',
            upsert: true
          })

        if (error) throw error

        showStatus('‚úÖ Upload realizado com sucesso!', 'success')
        showStatus(`üìÇ Caminho: ${data.path}`, 'info')

        // Obter URL p√∫blica
        const { data: urlData } = supabase.storage
          .from('form-documents')
          .getPublicUrl(filePath)

        showStatus(`üîó URL: <a href="${urlData.publicUrl}" target="_blank">${urlData.publicUrl}</a>`, 'success')

      } catch (error) {
        showStatus(`‚ùå Erro no upload: ${error.message}`, 'error')
        console.error('Detalhes do erro:', error)

        // Verificar poss√≠veis causas
        if (error.message.includes('new row violates row-level security')) {
          showStatus('üí° Problema: Pol√≠ticas de RLS bloqueando upload', 'info')
          showStatus('üí° Solu√ß√£o: Verifique as pol√≠ticas do bucket no Supabase', 'info')
        }
        if (error.message.includes('Bucket not found')) {
          showStatus('üí° Problema: Bucket "form-documents" n√£o existe', 'info')
          showStatus('üí° Solu√ß√£o: Crie o bucket no Supabase Dashboard', 'info')
        }
      }
    }
  </script>
</body>
</html>
